# DarkCall — PRO (Xirsys + авто‑фейловер)

Ты дал cURL для Xirsys — я **вшил** его в проект и добавил 2 способа получения ICE:
1) Через **Netlify Function** (безопаснее, ключи не светятся).
2) **Прямой запрос** из браузера (как в твоём cURL) — на случай, если хочешь «просто и сразу».

Плюс сделал **авто‑фейловер**:
- Если соединение застряло на «Подключение…» → авто‑переключение на **TURN (relay)** и ICE‑рестарт.
- Если во время звонка **пропал трафик** (по статистике RTP) → автоматический ICE‑рестарт и попытка сменить политику STUN↔TURN, чтобы звонок **не отваливался**.

## Что править под себя
- `xirsys-config.js` — твои креды (я вставил твои: `DevDemon / 66d34f1a-97a5-11f0-a5dc-0242ac130002 / MyFirstApp`).  
  ⚠️ Это видно в исходниках. Если хочешь безопасно — используй функцию ниже.
- `netlify/functions/xirsys-ice.js` — прокси к Xirsys (чтобы скрыть креды).  
  В Netlify в переменные окружения поставь:
  - `XIRSYS_USER=DevDemon`
  - `XIRSYS_SECRET=66d34f1a-97a5-11f0-a5dc-0242ac130002`
  - `XIRSYS_CHANNEL=MyFirstApp`

## Как это работает
- Файл `ice-provider.js` сначала пытается получить ICE через Netlify‑функцию: `/.netlify/functions/xirsys-ice`. Если её нет или ошибка — делает **прямой** запрос в Xirsys по твоему cURL. Если и это не вышло — берёт кэш или STUN Google.
- В `app.js` перед созданием `RTCPeerConnection` мы забираем актуальные ICE сервера и выставляем политику:
  - **Авто**: сначала `all` (STUN+TURN), если не коннектится — **сам** переключается на `relay` (только TURN).
  - Можно вручную включить «Только TURN (relay)» в интерфейсе.

## Деплой на Netlify
- Положи всё содержимое архива в корень репозитория.  
- Если планируешь Netlify Functions: структура уже есть `netlify/functions/xirsys-ice.js`.  
- Включи переменные окружения (Site Settings → Environment).  
- **Build command:** пусто. **Publish directory:** `/` (корень).

## Проверка
1. Открой сайт → «Создать звонок» → поделись ссылкой.  
2. Если долго «Подключение…» — через ~9 секунд **авто‑переключение на TURN**.  
3. Во время звонка при пропаже трафика скрипт делает ICE‑рестарт; звонок не должен сам «падать».

## Важно
- Xirsys — бесплатные лимиты ограничены. Если трафик большой, возьми платный план/свой coturn.  
- Ключи, зашитые в `xirsys-config.js`, видны всем посетителям. Для безопасности используй Netlify Function (или свой бэкенд) — я уже приложил готовый код.
